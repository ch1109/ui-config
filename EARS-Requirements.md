# UI Config 智能配置系统 - EARS 需求规格文档

## 文档信息

| 项目 | 内容 |
|------|------|
| 项目名称 | UI Config 智能配置系统 |
| 版本 | v1.0.0 |
| 创建日期 | 2026-01-06 |
| 模型依赖 | Qwen3-VL-8B-Instruct |

---

## 系统概述

本系统是一个基于 Python 后端的 UI 配置管理平台，通过接入 Qwen3-VL-8B 视觉语言模型，实现从页面截图自动解析生成结构化 UI Config 配置的能力。系统支持 AI 辅助的多轮澄清对话、可视化配置编辑，以及 MCP 服务器管理功能。

## 权限与用户范围

本版本为 **单用户 Demo**，暂不包含登录与鉴权机制，所有接口默认在可信内网环境下使用。

**Demo 版本约定**：
- 系统假设只有一个用户在操作，不考虑多用户并发编辑冲突
- 外部 URL 图片解析功能仅支持可信来源，不做完整 SSRF 防护
- 数据安全性依赖部署环境的网络隔离

若后续进入多用户或线上场景，需要补充：权限控制、资源归属策略、完整安全防护。

---

## 功能模块划分

| 模块编号 | 模块名称 | 核心职责 |
|----------|----------|----------|
| M1 | System Prompt 配置管理 | 全局 VL 模型提示词配置 |
| M2 | 页面截图智能解析 | 图片上传与 VL 模型语义识别 |
| M3 | 多轮澄清对话 | AI 主动澄清与动态对话管理 |
| M4 | JSON Config 生成 | 标准化配置生成与 Schema 验证 |
| M5 | 可视化配置编辑 | 配置展示、编辑与同步 |
| M6 | MCP 服务器管理 | 预制与自定义 MCP 接入 |

---

## 模块 M1: System Prompt 配置管理

### 1.1 基础属性需求

**REQ-M1-001**: System Prompt 配置模块应支持全局唯一的提示词配置，该配置适用于所有页面的 VL 模型解析任务。

**REQ-M1-002**: System Prompt 输入框应支持最多 10,000 字符的文本内容，并建议不少于 100 字符。

**REQ-M1-003**: System Prompt 配置界面应在页面加载完成后 1 秒内渲染就绪。

### 1.2 核心交互需求

**REQ-M1-004**: 当用户访问"UI Config 提示词配置"页面时，系统应加载并显示当前保存的 System Prompt 内容，若无保存内容则显示默认模板。

**REQ-M1-005**: 当用户在文本输入框中修改 System Prompt 内容时，系统应实时显示当前字符数（格式：当前字符数/最大字符数）。

**REQ-M1-006**: 当用户点击"保存"按钮时，系统应将 System Prompt 内容持久化存储至数据库，并显示"保存成功"提示，提示持续 3 秒后自动消失。

**REQ-M1-007**: 当用户点击"恢复默认"按钮时，系统应弹出确认对话框，用户确认后将 System Prompt 恢复为系统预设的默认模板。

### 1.3 异常处理需求

**REQ-M1-008**: 如果用户输入的 System Prompt 超出 10,000 字符限制，系统应阻止继续输入，并在输入框下方显示红色提示"已达到最大字符限制"。

**REQ-M1-012**: 如果 System Prompt 内容少于 100 字符，系统应显示提示"建议不少于 100 字符以提升解析效果"，但允许保存。

**REQ-M1-013**: ~~当用户保存 System Prompt 时，系统应检测配置是否在本次编辑期间被他人更新，若已更新则提示"配置已被修改，请刷新后再保存"，并拒绝覆盖。~~ *(Demo 版本为单用户场景，此需求暂不实现)*

**REQ-M1-009**: 如果保存 System Prompt 时数据库连接失败，系统应显示错误提示"保存失败，请检查网络后重试"，并提供"重试"按钮。

**REQ-M1-010**: 如果用户在修改 System Prompt 后未保存即尝试离开页面，系统应弹出确认对话框"您有未保存的更改，确定要离开吗？"

### 1.4 完整流程需求

**REQ-M1-011**: System Prompt 配置的完整流程应包括：
- 步骤1: 用户进入配置页面，系统加载当前配置或默认模板
- 步骤2: 用户在文本框中编辑 System Prompt 内容
- 步骤3: 用户点击"保存"按钮，系统验证内容最大长度（10,000）
- 步骤4: 验证通过后，系统保存至数据库并显示成功提示
- 异常处理: 若验证失败或保存失败，显示对应错误信息并停留在当前页面

---

## 模块 M2: 页面截图智能解析

### 2.1 基础属性需求

**REQ-M2-001**: 图片上传组件应支持 PNG 和 JPG 两种格式的图片文件。

**REQ-M2-002**: 单次上传的图片文件大小应限制在 10MB 以内。

**REQ-M2-003**: 系统应支持单图上传模式，每次解析仅处理一张截图。

**REQ-M2-004**: VL 模型解析应在 30 秒内返回结果，超时则中断并提示用户。

### 2.2 核心交互需求

**REQ-M2-005**: 当用户点击"添加页面"按钮时，系统应跳转至页面配置表单，表单左侧显示图片上传区域，右侧显示基本信息表单。

**REQ-M2-006**: 当用户将图片拖拽至上传区域或点击上传区域选择文件时，系统应显示上传进度条，上传完成后在上传区域预览图片缩略图。

**REQ-M2-007**: 当用户点击"AI 辅助填写"按钮时，系统应：
- 调用 Qwen3-VL-8B-Instruct 模型
- 将上传的图片与当前 System Prompt 作为输入
- 执行语义级解析（元素识别 + 交互意图 + 业务含义推断）

**REQ-M2-008**: 当 VL 模型完成解析时，系统应将识别结果自动填充至表单对应字段，包括：
- 页面名称（中英文）
- 页面描述
- 支持的意图列表
- 可点击按钮列表
- AI 行为规则建议
- 页面目标建议

### 2.3 状态持续需求

**REQ-M2-009**: 在 VL 模型解析进行期间，系统应：
- 显示加载动画和"AI 正在分析页面..."提示
- 禁用"AI 辅助填写"按钮防止重复调用
- 禁用表单所有输入字段防止冲突编辑

### 2.4 异常处理需求

**REQ-M2-010**: 如果用户上传的文件格式不是 PNG 或 JPG，系统应拒绝上传，并显示提示"仅支持 PNG、JPG 格式的图片"。

**REQ-M2-011**: 如果用户上传的文件大小超过 10MB，系统应拒绝上传，并显示提示"图片大小不能超过 10MB"。

**REQ-M2-012**: 如果 VL 模型解析超时（>30秒），系统应中断请求，显示提示"解析超时，请重试或尝试上传更清晰的截图"，并恢复表单可编辑状态。

**REQ-M2-013**: 如果 VL 模型解析失败（模型返回错误），系统应显示提示"解析失败：[错误信息]"，并记录错误日志供排查。

**REQ-M2-014**: 如果用户未上传图片即点击"AI 辅助填写"，系统应显示提示"请先上传页面截图"。

**REQ-M2-015**: 系统应支持对外部 URL 图片进行解析，仅允许 http/https 协议。

**REQ-M2-016**: 当解析外部 URL 时，系统应进行 SSRF 防护校验（拒绝内网/本地/保留地址、禁止 file 等非 http/https 协议），并限制单次拉取的最大响应体为 10MB。

**REQ-M2-017**: 当解析外部 URL 时，系统应校验图片 Content-Type 为 image/png 或 image/jpeg，不符合则拒绝解析并提示"仅支持 PNG、JPG 格式的图片"。

**REQ-M2-018**: 当解析本地文件路径时，系统仅允许读取 uploads 目录下的文件。

**REQ-M2-019**: 图片上传应采用流式写入方式落盘，避免一次性读入内存导致高并发 OOM 风险。

**REQ-M2-020**: 系统应提供临时截图清理策略，自动清理超过 24 小时且未关联到已保存 PageConfig 的图片。

**REQ-M2-021**: 当模型返回内容无法解析为 JSON 时，系统应自动触发一次纠错重试，并在失败后提示"解析失败，请重试"。

---

## 解析会话状态机

页面解析会话（ParseSession）的状态流转如下：

```
┌─────────┐
│ pending │ ← 初始状态：会话创建后等待解析
└────┬────┘
     │ 开始解析
     ▼
┌─────────┐
│ parsing │ ← VL 模型解析中
└────┬────┘
     │ 解析完成
     ├───────────────────────┐
     ▼                       ▼
┌───────────┐          ┌──────────┐
│ clarifying│ ←────────│ completed│ ← 置信度≥85% 或无需澄清
└─────┬─────┘  用户确认 └──────────┘
      │                      ▲
      │ 每轮澄清后判断       │
      ├──────────────────────┘
      │ 置信度≥85% / 达到5轮 / 用户确认
      │
      │ 解析失败 / 超时
      ▼
┌────────┐
│ failed │ ← 可重新触发解析
└────────┘
```

**状态说明**：
- `pending`: 会话已创建，等待后台任务开始解析
- `parsing`: VL 模型正在分析图片
- `clarifying`: 需要用户回答澄清问题
- `completed`: 配置已生成完毕
- `failed`: 解析失败，用户可重新上传图片或重试

---

## 模块 M3: 多轮澄清对话

### 3.1 基础属性需求

**REQ-M3-001**: 澄清对话模块应支持动态轮次，直到满足以下任一条件结束澄清：
- 模型置信度达到阈值（≥85%）
- 用户主动点击"完成配置"或输入"确认"
- 达到最大澄清轮次（5 轮），此时提示用户手动完善配置

**REQ-M3-002**: 单轮对话的 AI 响应应在 15 秒内返回。

**REQ-M3-003**: 澄清对话的历史记录应保留在当前会话中，前端刷新后清空展示，但服务端仍保留当前会话内历史以支持查询接口。

### 3.2 核心交互需求

**REQ-M3-004**: 当 VL 模型完成初步解析后，系统应自动触发澄清流程，在右侧 AI 助手面板显示模型识别的不明确点和澄清问题。

**REQ-M3-005**: 当 AI 提出澄清问题时，系统应以对话气泡形式展示问题，并提供以下交互方式：
- 文本输入框供用户自由回答
- 快捷选项按钮（如适用）供用户快速选择

**REQ-M3-006**: 当用户回答澄清问题后，系统应：
- 将用户回答发送至模型
- 模型基于新信息更新配置草稿
- 判断是否需要继续澄清

**REQ-M3-007**: 当模型判断无需继续澄清（置信度≥85%）时，系统应在 AI 面板显示"配置已生成，请查看右侧表单"，并将最终配置填充至表单。

**REQ-M3-008**: 当用户在对话框输入"确认"或点击"完成配置"按钮时，系统应结束澄清流程，锁定当前配置为最终版本。

### 3.3 状态持续需求

**REQ-M3-009**: 在澄清对话进行期间，系统应：
- 在表单字段旁显示"待确认"标记（黄色标签）
- 允许用户随时手动修改表单内容
- 保持 AI 面板可见且可交互

### 3.4 异常处理需求

**REQ-M3-010**: 如果澄清对话响应超时（>15秒），系统应显示提示"AI 响应超时，正在重试..."，并自动重试一次，若仍失败则显示"请手动完善配置或稍后重试"。

**REQ-M3-011**: 如果用户连续 5 分钟未响应澄清问题，系统应在 AI 面板显示提示"您似乎暂时离开了，当前配置已自动保存为草稿"。

### 3.5 复合场景需求

**REQ-M3-012**: ~~在用户已完成图片上传的前提下，当用户修改了表单中的某个字段时，如果该字段与 AI 之前的澄清问题相关，系统应自动更新对话上下文~~ *(Demo 版本简化：用户手动修改后，AI 不再自动追问，由用户自行决定是否继续对话)*

**REQ-M3-013**: 当 AI 更新配置时，若用户已手动修改过表单，系统应提示"AI 已更新配置，是否覆盖当前修改？"，用户可选择"应用"或"保留我的修改"。*(Demo 版本采用简单的 isDirty 标记判断)*

**REQ-M3-014**: 澄清历史应以 clarify_history 为唯一事实来源，parse_result 仅保存最终配置快照，避免重复来源导致不一致。

---

## 模块 M4: JSON Config 生成

### 4.1 基础属性需求

**REQ-M4-001**: 生成的 JSON Config 应严格符合以下 Schema 结构：

```json
{
  "pages": {
    "[page_id]": {
      "name": {
        "zh-CN": "中文页面名称",
        "en": "English Page Name"
      },
      "description": {
        "zh-CN": "中文页面描述",
        "en": "English page description"
      },
      "buttonList": ["button_id_1", "button_id_2"],
      "optionalActions": ["action_1", "action_2"]
    }
  }
}
```

**REQ-M4-002**: JSON Config 的字段要求如下：
| 字段路径 | 类型 | 必填 | 说明 |
|----------|------|------|------|
| pages | Object | 是 | 页面配置集合 |
| pages.[page_id] | Object | 是 | 单个页面配置，page_id 为英文标识 |
| pages.[page_id].name | Object | 是 | 页面名称，包含中英文 |
| pages.[page_id].name.zh-CN | String | 是 | 中文名称 |
| pages.[page_id].name.en | String | 是 | 英文名称 |
| pages.[page_id].description | Object | 是 | 页面描述，包含中英文 |
| pages.[page_id].description.zh-CN | String | 是 | 中文描述 |
| pages.[page_id].description.en | String | 是 | 英文描述 |
| pages.[page_id].buttonList | Array | 是 | 可点击按钮 ID 列表 |
| pages.[page_id].optionalActions | Array | 否 | 可选操作列表 |

### 4.2 核心交互需求

**REQ-M4-003**: 当澄清对话结束或用户点击"生成配置"按钮时，系统应基于当前表单数据生成 JSON Config。

**REQ-M4-004**: 当 JSON Config 生成完成时，系统应执行 Schema 验证，验证通过后在页面下方展示格式化的 JSON 预览。

**REQ-M4-005**: 当用户点击"复制 JSON"按钮时，系统应将 JSON Config 复制至剪贴板，并显示"已复制到剪贴板"提示。

**REQ-M4-006**: 当用户点击"下载 JSON"按钮时，系统应触发文件下载，文件名格式为"[page_id]_config_[timestamp].json"。

### 4.3 异常处理需求

**REQ-M4-007**: 如果生成的 JSON Config 未通过 Schema 验证，系统应：
- 在 JSON 预览区域高亮显示错误字段
- 在预览区域上方显示具体的验证错误信息
- 阻止保存操作直到错误修复

**REQ-M4-008**: 如果必填字段（name、description）为空，系统应在对应表单字段下方显示红色提示"此字段为必填项"。

**REQ-M4-009**: buttonList 至少包含 1 个按钮 ID；如果为空，系统应在按钮列表区显示提示"至少保留一个按钮配置"并阻止保存。

**REQ-M4-010**: optionalActions 允许任意字符串，不做枚举限制。

---

## 模块 M5: 可视化配置编辑

### 5.1 基础属性需求

**REQ-M5-001**: 可视化编辑器应以表格+列表形式展示 JSON Config 中的所有字段。

**REQ-M5-002**: 编辑器应支持手动保存模式，用户修改后需点击"保存"按钮才会更新 JSON Config。

### 5.2 核心交互需求

**REQ-M5-003**: 当页面配置加载完成时，系统应在可视化编辑器中展示以下内容：
- 基本信息区：页面名称（中/英文）、英文标识、页面描述（中/英文）
- 页面能力区：支持的意图列表、可点击按钮列表
- AI 上下文区：行为规则、页面目标

**REQ-M5-004**: 当用户双击某个字段值时，系统应将该字段切换为编辑模式，显示输入框供用户修改。

**REQ-M5-005**: 当用户在按钮列表区点击"+ 添加"按钮时，系统应在列表末尾新增一个空白按钮项，光标自动聚焦至新项输入框。

**REQ-M5-006**: 当用户点击某个按钮项的"删除"图标时，系统应弹出确认对话框，确认后从列表中移除该项。

**REQ-M5-007**: 当用户完成编辑并点击"保存"按钮时，系统应：
- 收集所有表单字段的当前值
- 重新生成 JSON Config
- 执行 Schema 验证
- 验证通过后保存至数据库并更新 JSON 预览

### 5.3 状态持续需求

**REQ-M5-008**: 在用户有未保存修改期间，系统应：
- 在页面标题旁显示"未保存"标记
- "保存"按钮高亮显示（主色调）
- 页面右上角显示"距上次保存：[时间]"

### 5.4 异常处理需求

**REQ-M5-009**: 如果用户尝试删除最后一个按钮项（buttonList 变为空），系统应显示提示"至少保留一个按钮配置"，并阻止删除操作。

**REQ-M5-010**: 如果保存时检测到字段值包含非法字符（如 JSON 特殊字符未转义），系统应高亮该字段并显示"包含非法字符，请修改"。

---

## 模块 M6: MCP 服务器管理

> **MCP 在本系统中的作用**：MCP（Model Context Protocol）服务器用于扩展 VL 模型的能力。当前 Demo 版本中，MCP 主要用于：
> - 预留扩展接口，后续可对接外部知识库、工具调用等能力
> - Context7 预置服务器可用于上下文增强（如获取页面相关的业务文档）
> 
> **Demo 版本说明**：MCP 功能为预留扩展，当前 VL 解析流程不强依赖 MCP 调用。

### 6.1 基础属性需求

**REQ-M6-001**: 系统应预置 Context7 MCP 服务器配置，开箱即用。

**REQ-M6-002**: 自定义 MCP 配置支持两种方式：
- JSON 文件上传（包含服务器地址、认证信息、工具定义）
- 代码编辑器直接编写 MCP 协议的配置

**REQ-M6-003**: 单个 MCP 配置文件大小应限制在 1MB 以内。

### 6.2 核心交互需求

**REQ-M6-004**: 当用户访问"MCP 服务器管理"页面时，系统应展示：
- 预制服务器区：展示 Context7 MCP 卡片，显示名称、状态（已启用/已禁用）、工具列表
- 自定义服务器区：展示用户添加的 MCP 服务器卡片

**REQ-M6-005**: 当用户点击预制服务器卡片的"启用/禁用"开关时，系统应切换该 MCP 服务器的启用状态，并保存设置。

**REQ-M6-006**: 当用户点击"添加自定义 MCP"按钮时，系统应弹出配置弹窗，包含：
- Tab1: 文件上传 - 拖拽或选择 JSON 配置文件
- Tab2: 代码编辑 - Monaco 代码编辑器，支持 JSON 语法高亮

**REQ-M6-007**: 当用户通过文件上传方式添加 MCP 配置时，系统应：
- 解析 JSON 文件
- 验证必需字段（server_url、tools）
- 测试服务器连通性
- 验证通过后添加至自定义服务器列表

**REQ-M6-008**: 当用户通过代码编辑器方式添加 MCP 配置时，系统应：
- 实时检测 JSON 语法错误并在编辑器中标红
- 用户点击"保存"时执行完整验证和连通性测试

**REQ-M6-009**: 当用户点击某个自定义 MCP 服务器卡片的"编辑"按钮时，系统应打开配置弹窗，加载该服务器的当前配置供编辑。

**REQ-M6-010**: 当用户点击某个自定义 MCP 服务器卡片的"删除"按钮时，系统应弹出确认对话框，确认后从列表中移除。

### 6.3 异常处理需求

**REQ-M6-011**: 如果上传的 MCP 配置文件不是有效的 JSON 格式，系统应显示错误提示"文件格式错误，请上传有效的 JSON 文件"。

**REQ-M6-012**: 如果 MCP 服务器连通性测试失败（超时 10 秒或连接被拒），系统应显示警告"服务器连接失败，配置已保存但可能无法正常使用"，仍允许保存配置。

**REQ-M6-013**: 如果用户尝试添加已存在的 MCP 服务器（URL 重复），系统应显示提示"该服务器已存在，是否覆盖现有配置？"

**REQ-M6-014**: MCP 服务器管理功能不做额外权限控制（所有登录用户可管理）。

**REQ-M6-015**: MCP 服务器连通性测试应支持自定义健康检查路径，默认使用 /health。

---

## 完整性检查结果

### 已覆盖需求统计

| 类型 | 数量 | 覆盖模块 |
|------|------|----------|
| 类型1: 基础属性型 | 14 个 | M1-M6 |
| 类型2: 触发响应型 | 24 个 | M1-M6 |
| 类型3: 状态持续型 | 4 个 | M2, M3, M5 |
| 类型4: 条件分支型 | 16 个 | M1-M6 |
| 类型5: 可选特性型 | 0 个 | - |
| 类型6: 复合场景型 | 1 个 | M3 |
| 类型7: 流程串联型 | 1 个 | M1 |

**总计: 60 个需求点**

### Demo 版本简化项

以下需求在 Demo 版本中简化或暂不实现：

| 需求编号 | 原需求 | Demo 处理 |
|----------|--------|-----------|
| REQ-M1-013 | 并发编辑冲突检测 | 单用户场景，不实现 |
| REQ-M2-016 | 完整 SSRF 防护 | 仅做基础协议校验 |
| REQ-M3-012 | 字段级修改追踪 | 简化为整体 isDirty 标记 |

### 验收标准清单

每个需求点均可转化为以下类型的测试用例：
- 单元测试：基础属性验证、Schema 验证
- 集成测试：模块间数据流转、API 调用
- E2E 测试：完整用户流程、异常场景
- 性能测试：响应时间、并发处理

---

## 附录 A: 术语表

| 术语 | 定义 |
|------|------|
| VL 模型 | Vision-Language Model，视觉语言模型，此处指 Qwen3-VL-8B-Instruct |
| UI Config | 页面配置信息的 JSON 结构化表示 |
| MCP | Model Context Protocol，模型上下文协议 |
| System Prompt | 系统提示词，用于引导 VL 模型的解析行为 |
| 置信度 | 模型对解析结果确定性的量化指标（0-100%） |
| Schema | JSON 结构定义，用于验证配置格式的正确性 |

## 附录 B: JSON Config Schema 完整示例

```json
{
  "pages": {
    "3.1id_verification": {
      "name": {
        "zh-CN": "3.1银信通-身份证验证",
        "en": "3.1 Yinxintong - ID card verification"
      },
      "description": {
        "zh-CN": "在此页面用户可进行以下操作：\n- 银信通签约的第一步：身份证验证\n- 银信通、金融相关的问答",
        "en": "On this page, users can do the following:\n- The first step of signing a contract with Bank Information Communication: ID card verification\n- Q&A related to banking, information and communication, and finance"
      },
      "buttonList": [
        "return_to_top_page",
        "id_forgot"
      ],
      "optionalActions": [
        "chat",
        "knowledge"
      ]
    }
  }
}
```
